<?php

use App\Page;
use App\User;
use App\Section;
use App\Translation;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\QueryException;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddVisualizations extends Migration
{
    public $pages = [];

    public function __construct()
    {
        $this->pages = [
            [
                'title'      => ['bg' => 'Настоящи миграции', 'en' => 'Current migrations'],
                'section_id' => '',
                'body'       => [
                    'bg' => '<div class="container grao"> <div class="row-fluid"> <h3> Регистрации по настоящ адрес</h3> <p> Визуализацията представя информацията за регистрациите по настоящ адрес на Главна дирекция „Гражданска регистрация и административно обслужване”, достъпни на Националния портал за отворени данни. <br>Данните са за периода 2011 – 2015 година и са актуални към май 2015 година. Предоставянето им е част от усилията на правителството за осигуряване на честни избори и отворено и прозрачно управление. <br>Големината на кръговете е пропорционална на съотношението на нетния брой нови регистрации за съответния месец към средния нетен брой нови регистрации през последните 3 месеца. Прилагането на тази методология позволява да се намали визуалният ефект, който биха предизвикали сезонни миграции, и да се фокусира вниманието върху неочаквани повишения в броя нови регистрации. <br>Суровите данни използвани в тази визуализация могат да бъдат свалени от <a href="https://github.com/governmentbg/data-viz/tree/gh-pages/assets/data/grao">тук</a>.<br></p></div><div id="path-tooltip" class="path-hidden"> <p><strong><span id="path-munci">Име на област</span></strong></p><p><span id="path-flowin">100</span></p><p><span id="path-flowout">100</span></p><p><span id="path-month">Дата: ян,</span><span id="path-year">2011</span></p></div><div id="date-box" class="row-fluid"> <p><span id="path-month">Дата: ян,</span><span id="path-year">2011</span></p></div><div id="map-container" class="row-fluid"> <div id="mapbg"></div></div><div id="animation-container" class="row-fluid"> <div id="play"></div><div id="slider-container"> <div id="slider-div"></div></div></div><div id="attributions" class="row-fluid"></div></div>
                    <script>"undefined"!=typeof d3&&$(function(){var t,e,a,r,n,i,l=1,o=2011,c=1,d=0,s=!1,u=!1,p=d3.select(".container").style("width"),f=parseInt(p,10),h=f/1.5,v=d3.geo.mercator(),m=d3.geo.path().projection(v),g=d3.select("#mapbg").append("svg").attr("width",f).attr("height",h),y=d3.scale.linear().domain([0,227.5]).range([0,100]),x=["ян","февр","март","апр","май","юни","юли","авг","септ","окт","ноем","дек"];d3.format("04d"),d3.format("0.00%");queue().defer(d3.json,"'. url('/assets/data/grao/geo.json') .'").defer(d3.json,"'. url('/assets/data/grao/grao_adj_final.json') .'").await(function(p,M,w){if(p)throw p;v.scale(1).translate([0,0]);var b=m.bounds(M),S=.9/Math.max((b[1][0]-b[0][0])/f,(b[1][1]-b[0][1])/h),j=[(f-S*(b[1][0]+b[0][0]))/2,(h-S*(b[1][1]+b[0][1]))/2];v.scale(S).translate(j);var I=g.append("g");e=w.data.length-1,a=w.data[e].data.length-1,c=Number(w.data[0].data[0].month),o=Number(w.data[0].Year),t=o,currentMonth=c;for(var N=0;N<w.data.length;N++)d+=w.data[N].data.length;i=d3.time.scale().domain([new Date(o,Number(w.data[0].data[0].month)-1),new Date(Number(w.data[e].Year),Number(w.data[e].data[a].month-1))]).range([0,f/1.3]);var P=d3.select("#path-tooltip"),k=d3.select("#date-box");I.selectAll("path").data(M.features).enter().append("path").attr("d",m).attr("fill","#bfbdc4").attr("id",function(t){return t.properties.name.replace(" ","")});function R(t,e){for(var a=0;a<w.data.length;a++)if(w.data[a].Year===t)for(var r=0;r<w.data[a].data.length;r++)if(r===e-1)return w.data[a].data[r]}function Y(t,e,a,r){for(var n=R(t,e),i=0;i<n.data.length;i++)if(n.data[i].Municipality===a)return n.data[i][r]}function F(t){for(var e in t){var a="#cir"+t[e].Municipality.replace(" ","");d3.select(a).datum(t[e])}n.sort(function(t,e){return e.Ratio-t.Ratio}),n.transition().ease("linear").duration(500).attr("r",function(t){return y(t.Ratio)}).attr("class",function(t){return t.NetMigration>0?"incre":"decre"})}function z(){interval=setInterval(function(){return l==d?(s=!1,d3.select("#play").classed("pause",!1).attr("title","Play animation"),void clearInterval(interval)):(l++,d3.select("#slider-div .d3-slider-handle").style("left",100*l/d+"%"),t=D(l)[0],currentMonth=D(l)[1],k.select("#path-month").text("Дата: "+x[currentMonth-1]),k.select("#path-year").text(", "+t),F(R(t.toString(),currentMonth).data),u&&A(l,currentMunicipality),l==d?(s=!1,d3.select("#play").classed("pause",!1).attr("title","Play animation"),void clearInterval(interval)):void 0)},1e3)}function A(t,e){var a=D(t)[0],r=D(t)[1];return P.select("#path-munci").text("Община: "+e),P.select("#path-flowin").text("Нови регистрации: "+Y(a.toString(),r,e,"FlowRegs")),P.select("#path-flowout").text("Дерегистрации: "+Y(a.toString(),r,e,"FlowDeregs")),P.select("#path-month").text("Дата: "+x[r-1]),P.select("#path-year").text(", "+a),P.transition().style("opacity",.9)}function D(t){if(0==t){var e=c,a=o;return[a,e]}var e=t%12==0?12:t%12,r=12==e?Math.floor(t/12)-1:Math.floor(t/12),a=o+r;return[a,e]}(function(t,e){var a=R(t.toString(),e).data;for(var r in a)I.append("circle").datum(a[r]).attr("cx",function(t){var e="#"+t.Municipality.replace(" ",""),a=d3.select(e),r=m.centroid(a.datum());return r[0]}).attr("cy",function(t){var e="#"+t.Municipality.replace(" ",""),a=d3.select(e),r=m.centroid(a.datum());return r[1]}).attr("r",function(t){return y(t.Ratio)}).attr("id",function(t){return"cir"+t.Municipality.replace(" ","")}).on("mouseover",function(t){currentMunicipality=t.Municipality,u=!0,A(l,currentMunicipality)}).on("mousemove",function(t){return P.style("top",d3.event.pageY+"px").style("left",d3.event.pageX+"px")}).on("mouseout",function(){return u=!1,P.style("opacity",0)})})(o,l),n=I.selectAll("circle"),F(R(t.toString(),l).data),k.select("#path-month").text("Дата: "+x[currentMonth-1]),k.select("#path-year").text(", "+t),function(){sliderScale=d3.scale.linear().domain([0,d]);var e=r?r.value():0;r=d3.slider().scale(sliderScale).on("slide",function(e,a){s&&clearInterval(interval),l=Math.round(a),t=D(l)[0],currentMonth=D(l)[1],k.select("#path-month").text("Дата: "+x[currentMonth-1]),k.select("#path-year").text(", "+t),F(R(t.toString(),currentMonth).data)}).on("slideend",function(){s&&z()}).value(e),d3.select("#slider-div").remove(),d3.select("#slider-container").append("div").attr("id","slider-div").style("width",f/1.3+"px").call(r),d3.select("#slider-div a").on("mousemove",function(){d3.event.stopPropagation()});var a=d3.svg.axis().scale(i).tickValues(i.ticks(d).filter(function(t,e){return 0==t.getMonth()||3==t.getMonth()||6==t.getMonth()||9==t.getMonth()})).tickFormat(function(t){return x[t.getMonth()]+" "+t.getFullYear().toString().substr(2)}).tickSize(5);d3.select("#axis").remove(),d3.select("#slider-container").append("svg").attr("id","axis").attr("width",i.range()[1]+40).attr("height",70).append("g").attr("transform","translate(20,0)").call(a).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(t){return"rotate(-85)"}),d3.select("#axis path").remove()}(),d3.select("#play").attr("title","Play animation").on("click",function(){s?(s=!1,d3.select(this).classed("pause",!1).attr("title","Play animation"),clearInterval(interval)):(s=!0,d3.select(this).classed("pause",!0).attr("title","Pause animation"),z())}),_=I.append("g").attr("id","legend").attr("transform","translate(560,10)"),_.append("circle").attr("class","incre").attr("r",10).attr("cx",-85).attr("cy",10),_.append("circle").attr("class","decre").attr("r",10).attr("cx",-85).attr("cy",30),_.append("text").text("нарастване в броя регистрации").style("font-size","12px").attr("x",-75).attr("y",13),_.append("text").text("намаление в броя регистрации").style("font-size","12px").attr("x",-75).attr("y",33);var _})}());</script>'
                ],
                'active'     => 1,
                'type'       => Page::TYPE_PAGE,
            ],
            [
                'title'      => ['bg' => 'Средно образование', 'en' => 'Secondary education'],
                'section_id' => '',
                'body'       => [
                    'bg' => '<div class="container education"> <div class="row-fluid sidebyside"> <h3> Средно и средно специално образование в България за 2015 </h3> <button type="button" class="btn btn-primary pull-right" data-toggle="modal" data-target="#infoModal" > <span class="glyphicon glyphicon-align-right" aria-hidden="true" ></span> </button> <div id="infoModal" class="modal fade" role="dialog"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal">&times;</button> <h4 class="modal-title">Нива на анализ</h4> </div><div class="modal-body"> <ul class="list-group"> <li class="list-group-item"> <h4> Национално ниво</h4> <p> Визуализацията опосредства пряк анализ на национално ниво. <br>Общините / районите без училища с диполомирали се ученици са показани в <i style="background:#cccccc">&nbsp&nbsp&nbsp</i><br>Общините, където усредненият общ среден успех на училищата е най-нисък, са оцветени ярко в <i style="background:#FE1E13">&nbsp&nbsp&nbsp</i>. Критично е да бъде повишено качеството на образованието в тези общини. През 2015, в следните общини средният успех е под 3.00 : Лъки, Маджарово, Аврен, Брезово, Бойчиновци, Стамболово.<br>С помощта на падащото меню може лесно да се промени преспективата, така че оцветяването на общините да е според резултатите по определен предмет. </p></li><li class="list-group-item"> <h4> Регионално ниво</h4> <p> Аналитичният инструмент позволява анализ на регионално ниво подредством избор на един или няколко общини.<br>На картата се визуализират училищата във всички райони, попадащи в селекцията. В горния ляв ъгъл на карта е показан общият им брой,а в долния ляв ъгъл се появява хистограма на резултатите на избраните училища според общия им среден успех.<br>Тези основни инструменти показват базовата агрегация на избраната информация.<br></p></li><li class="list-group-item"> <h4> Локално ниво</h4> <p> Аналитичният инструмент позволява и локален анализ чрез фокусиране върху конкретен географски регион на картата. По този начин може да се направи пространствен анализ за достъпа до училища в конкретен район и анализ на качеството на образованието, предоставяно на учениците в тези райони.<br>При избор на определено училище се появява информационна карта с успеха на учениците по предмети, така че гражданите могат да могат да сравнят представянето на училищата по учебен предмет от интерес, а образователните администрации да следят за осигуряване качеството на средното и средното професионално образование. <br></p></li></ul> </div><div class="modal-footer"> <button type="button" class="btn btn-default" data-dismiss="modal">Затвори</button> </div></div></div></div><br><br><p> Настоящата страница предоставя средство за анализ на данните от положените ДЗИ за 2015 година, достъпни на портала на инициативата "Отворени данни"<br>Избирайки община, ще предизвикате появата на всички училища в съответния район, за които има налична информация от 2015 ДЗИ. Училищата с общ успех в рамките на най-добрите 10% сред избраните са представени със син маркер, а останалите с жълт. Селектиране на конкретно училище ще покаже кратка визитка и сравнителна карта с информация за средните изпитни резултати по предмети. Когато училището е сред най-добрите 25% в страната по определен предмет до съответния резултат има звезда, обратно, ако резултатът е сред най-ниските 25% се появява червена точка.<br>За подробна информация как настоящия инструмент може да бъде използван за анализ на образователната система на различни три нива - национално, регионално и локално, натиснете бутона в дясно.<br>Суровите данни използвани в тази визуализация могат да бъдат свалени от <a href="https://github.com/governmentbg/data-viz/tree/gh-pages/assets/data/edu-map">тук</a>.<br></p></div><div class="vdivider"></div><div id="mapNav"> <nav role="navigation" class="navbar navbar-default"> <div id="navbarCollapse" class="collapse navbar-collapse"> <ul class="nav navbar-nav"> <li id="navLabel"><a>Оценяване на картата според успеха по :</a></li><li id="navSelector" class="dropdown"> <a id="subjectLabel" data-toggle="dropdown" class="dropdown-toggle" >Общо<b class="caret"></b></a> <ul role="menu" class="dropdown-menu" aria-labelledby="dLabel"></ul> </li></ul> </div></nav> </div><div id="mapLeaf"></div><div class="vdivider"></div><div class="row-fluid sidebyside"> Представени са данните достъпни на правителствения портал "Отворени данни". Кратката информация за всяко училище е извлечена от базата данни на МОН. Географската локация на всяко училище е на база геокодиране адреса на съответното училище в базата на МОН, евристичен подход за прецизиране на локацията и ръчна обработка.<br>Все пак, поради липса или промяна имената на улиците за някои населени места, нееднозначност на адреса и др., е възможно определени учебни заведения на не са изобразени на точната си локация. Ако забележите подобни случаи, можете да преместите маркера за съответното училище на по-точната локация. Помогнете ни, като ни изпратите новата локация по мейла. Благодарим Ви!<br></div><div class="vdivider"></div><button id="locationMail" type="button" class="btn btn-primary">Изпрати ни промените по мейл</button> <div class="vdivider"></div><div class="row-fluid sidebyside">Списък с промените<br></div><pre id="locationChanges" class="sidebyside"></pre> </div><script>!function(){var t=.65*$(window).height(),e=!0;if($(window).width()>=980){var n=900;$("#mapNav .navbar").css("max-width",n)}else{e=!1,$("#navLabel").remove(),$(".vdivider").remove();var o=$("#navSelector")[0].outerHTML;$("#mapNav").empty(),$("#mapNav").append("<ul role=\'navigation\' class=\'nav navbar-nav\'>"),$("#mapNav .nav").append(o),$("#mapNav ul").css({width:"50%"});n=.9*$(window).width()}var a=void 0,r="Total",i=["#FE1E13","#C04523","#DFBE10","#91BB11"],s=[2,3,4,5],d=!1,l=!1,c=!1,p=[],h=[],u={};$("#mapLeaf").width(n).height(t),$(".leaflet-control-container").width(n/5).height(t/5),$("#mapNav .navbar").css({"margin-bottom":0}),queue().defer(d3.json,"'. url('/assets/topojson/bg-simple.json') .'").defer(d3.json,"'. url('/assets/data/edu-map/school-profile.json') .'").defer(d3.json,"'. url('/assets/data/edu-map/school-data.json') .'").defer(d3.json,"'. url('/assets/data/edu-map/recoded-en-bg.json') .'").defer(d3.json,"'. url('/assets/data/edu-map/recoded-bg-en.json') .'").await(function(o,i,s,m,b,A){if(o)throw o;var C=topojson.feature(i,i.objects.regions),E=k(s,m,"Obshtina","ID",r),P=d3.geo.transform({point:S}),U=d3.geo.path().projection(P),R=T.selectAll("path").data(C.features).enter().append("path").style("fill",function(t){var e=b.obshtini[t.properties.obshtina],n=M(E,e);return void 0!=e?f(n):"#cccccc"}).on("mousedown",function(){d=!1,l=!1}).on("mousemove",function(){d=!0}).on("mouseup",function(){l=d,d=!1}).on("mouseover",function(t){O.update(t,s,m,b,A)}).on("mouseout",function(t){O.update()}).on("click",function(o){void 0!=b.obshtini[o.properties.obshtina]&&function(o){if(l)return;if(d3.event.defaultPrevented)return;d3.event.stopPropagation(),y.removeLayer(D);var r=b.obshtini[o.properties.obshtina];if(o&&a!==o){a=o,newSchoolIDs=N(s,"Obshtina",[r],"ID"),p=p.concat(newSchoolIDs);var i=N(m,"ID",p,"Scores","Total",0);threshold=B(.9,i);var d=(f=s,A="ID",w=newSchoolIDs,$.grep(f,function(t){return $.inArray(t[A],w)>-1})),c=$.map(d,function(t){return e=t,v={type:"Feature",properties:{ID:e.ID,SchoolName:e.SchoolName,Oblast:e.Oblast,Obshtina:e.Obshtina,NaselenoMqsto:e.NaselenoMqsto,SchoolAdmin:e.SchoolAdmin,SchoolType:e.SchoolType,Address:e.Address},geometry:{type:"Point",coordinates:[e.Longitude,e.Latitude]}},v;var e});h=h.concat(c),D=L.geoJson(h,{pointToLayer:function(t,e){var o=N(m,"ID",[t.properties.ID],"Scores","Total",0),a=void 0;return a=o>=threshold?new g({iconUrl:"'. url('/img/pin-blue-2.png') .'"}):new g,L.marker(e,{icon:a,draggable:!0}).on("dragend",function(t){var e={};e[String(t.target.feature.properties.ID)]=t.target.getLatLng(),$.extend(u,e),$("#locationChanges").width(.9*n),$("#locationChanges").html(JSON.stringify(u,void 0,2))})},onEachFeature:x}).addTo(y),y.on("popupopen",function(e){var o=e.popup._source.feature;if(y.setView(new L.LatLng(o.geometry.coordinates[1]+.1,o.geometry.coordinates[0]),11,{animate:!0}),!$("#schoolRank").html().length){var a=N(m,"ID",[o.properties.ID],"Scores")[0],r=d3.select(".histChart svg");r.selectAll("line").remove(),function(t,e,n,o,a,r){validData=[],validData=$.grep(Object.keys(t),function(e){return null!=t[e][0]});var i=d3.select("#schoolTbl");i.append("thead").append("tr").selectAll("th").data(["Предмет","Ср.успех","Бр","Ср.успех община","Ср.успех област"]).enter().append("th").text(function(t){return t});var s,d,l,c,p=i.append("tbody").selectAll("tr").data(validData).enter().append("tr"),h=[],u=[];p.append("td").html(function(t){return e[t]}),p.append("td").html(function(e,i){res="";var s=t[e][0],d=$.map(r,function(t,n){return t.Scores[e][0]}),l=B(.75,d),c=B(.25,d),p=k(a,r,"Obshtina","ID",e),g=M(p,n);h.push(g);var f=k(a,r,"Oblast","ID",e),v=M(f,o);return u.push(v),res=s>=g&&s>=v&&s>=l?\'<img src="'. url('/img/marker-star-1.png') .'">\'+s:s<g&&s<v&&s<c?\'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAMAAAHQVe0RAAAAclBMVEWTyZP/tbXExP/f3/9ERP+Bgf/S0v/09P9ZWf/7+///k5P/RERubv/0+vT/+/ulpf//9PT/paUYGP//AAD/Li6BwIH/0tL/39/q6v//xMSTk/////8YjBguLv+1tf/q9er/bm4AgAD/GBj/gYH/6uoAAP80qE9XAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB98MBhENIrINQGkAAABDSURBVBjTlY9RCgAwCEK9w7v/XUeDWEVB88fQ0JIMyAGRqQaXCHoCuMUbxbjfJ9SsGFZH/VeMjekLsg6NuhfbzNXhB/bvCTXbbIjfAAAAAElFTkSuQmCC">\'+s:s,res}),p.append("td").html(function(e){return t[e][1]}),p.append("td").html(function(t,e){return h[e].toFixed(2)}),p.append("td").html(function(t,e){return u[e].toFixed(2)}),$(document).ready(function(){$("#schoolTbl").DataTable({scrollY:"200px",paging:!1,searching:!1,info:!1,order:[]})}),s=k(a,r,"Obshtina","ID","Total")[n].sort(function(t,e){return e-t}),d=k(a,r,"Oblast","ID","Total")[o].sort(function(t,e){return e-t}),l=$.inArray(t.Total[0],s)+1,c=$.inArray(t.Total[0],d)+1,$("#schoolRank").html("На "+l+" място от "+s.length+" в Община "+n+" и на "+c+" място от "+d.length+" в Област "+o)}(a,b.subjects,o.properties.Obshtina,o.properties.Oblast,s,m);r.data()[0];var i=d3.scale.linear().domain([2,6]).range([0,n/5]),d=a.Total[0];r.append("line").attr("x1",i(d)).attr("y1",10).attr("x2",i(d)).attr("y2",t/5).attr("stroke-width",2).attr("stroke","black")}}).on("popupclose",function(t){var e=d3.select(".histChart svg");e.selectAll("line").remove()})}else a=null,p=[],h=[];var f,A,w;if(e){j.update(i);var T=N(s,"ID",p,"SchoolAdmin");I.update([m.length,p.length],T)}}(o)});function _(){var t=U.bounds(C),e=t[0],n=t[1];w.attr("width",n[0]-e[0]).attr("height",n[1]-e[1]).style("left",e[0]+"px").style("top",e[1]+"px"),T.attr("transform","translate("+-e[0]+","+-e[1]+")"),R.attr("d",U)}y.on("viewreset",_).on("zoomend",function(){y.getZoom()>9&&(R.style("opacity",0),$(".info").fadeOut("slow")),y.getZoom()<9&&(R.style("opacity",1),$(".info").fadeIn("slow"))}),_(),d3.select(".dropdown-menu").selectAll("li").data(Object.keys(A.subjects)).enter().append("li").append("a").text(function(t){return t}).on("click",function(t){var n=k(s,m,"Obshtina","ID",A.subjects[t]);d3.select("#subjectLabel").text(t).append("span").attr("class","caret"),d3.selectAll("path").transition().duration(1e3).style("fill",function(t){if(t){var e=b.obshtini[t.properties.obshtina],o=M(n,e);return o>0?f(o):"#cccccc"}return"#cccccc"}),($(".progressBar svg").length||c)&&e&&I.update([m.length,p.length])})});var g=L.Icon.extend({options:{iconUrl:"'. url('/img/pin-yellow-2.png') .'",iconSize:[40,40],popupAnchor:[0,0]}}),f=d3.scale.linear().domain(s).range(i),m=L.latLng(44.904889,20.201375),b=L.latLng(40.717647,29.749023),A=L.latLngBounds(b,m),y=new L.Map("mapLeaf",{center:[42.654,25.002],zoom:7,zoomControl:!1,maxBounds:A,maxZoom:19,minZoom:7}).addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:\'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors\'})),w=d3.select(y.getPanes().overlayPane).append("svg"),T=w.append("g").attr("class","leaflet-zoom-hide"),D=L.geoJson().addTo(y);function S(t,e){var n=y.latLngToLayerPoint(new L.LatLng(e,t));this.stream.point(n.x,n.y)}if(d3.select("#dLabel").on("click",function(){d3.select(".sideCharts svg").remove(),c=!1}),e){var I=L.control({position:"topleft"});I.onAdd=function(t){return c=!0,this._div=L.DomUtil.create("div","sideCharts"),$(this._div).append($("<div>").attr("class","progressName")),$(this._div).append($("<div>").attr("class","progressChart")),$(this._div).append($("<div>").attr("class","sliceName")),$(this._div).append($("<div>").attr("class","sliceChart")),this._div},I.update=function(t,e){void 0===t||0===t[1]?$(".sideCharts").fadeOut("slow"):($(".sideCharts").length&&$(".sideCharts").fadeIn("slow"),$(".progressName").html("<p> Избрани училища брой</p>"),d3.select(".progressChart").datum(t).call(progressChart().margin({top:0,right:0,bottom:0,left:0}).width(n/5).height(20)),$(".sliceName").html("<p> Избрани училища тип</p>"),d3.select(".sliceChart").datum(e).call(pieChart().margin({top:0,right:0,bottom:0,left:0}).width(n/5).height(n/5).radius(n/10).color(d3.scale.ordinal().domain(["Държавно","Общинско","Частно"]).range(["#3182bd","#9ecae1","#c6dbef"]))))},I.addTo(y);var j=L.control({position:"bottomleft"});j.onAdd=function(t){return this._div=L.DomUtil.create("div","histChart"),this._div},j.update=function(e){void 0===e?$(".histChart").fadeOut("slow"):($(".histChart").fadeIn("slow"),this._div.innerHTML="<p>Хистограма избрани училища</p>",d3.select(".histChart").datum(e).call(histogramChart().margin({top:0,right:0,bottom:20,left:0}).width(n/5).height(t/5).range([2,6]).bins(Array.apply(0,Array(9)).map(function(t,e){return 2+.5*e})).tickFormat(d3.format(".02f"))))},j.addTo(y);var C=L.control({position:"bottomright"});C.onAdd=function(t){for(var e,n,o=L.DomUtil.create("div","info legend"),a=s,r=i,d=[],l=0;l<a.length;l++)e=a[l],n=a[l+1],d.push(\'<i style="background:\'+r[l]+\'"></i> \'+e+(n?"&ndash;"+n:"+"));return o.innerHTML="<h6> Оцветяване на общините <br> според ср. успех </h6><p>"+d.join("<p>"),o},C.addTo(y)}var O=L.control({position:"topright"});function x(t,e){var n="<div id=\'schoolInfo\'><strong>Училище: </strong>"+t.properties.SchoolName+"<br><strong>Тип: </strong>"+t.properties.SchoolAdmin+"<br><strong>Вид: </strong>"+t.properties.SchoolType+"<br><strong>Адрес: </strong>"+t.properties.Address+"<br><strong>Община: </strong>"+t.properties.Obshtina+"<br><strong>Област: </strong>"+t.properties.Oblast+"<br></div>"+"<div id=\'schoolRank\'></div><table id=\'schoolTbl\' class=\'display\' cellspacing=\'0\' width=\'80%\'>";e.bindPopup(n,{maxWidth:"400px","maxHeight:":"300px",autoPan:!1,zoomAnimation:!1})}function N(t,e,n,o,a,r){return $.map(t,function(t){return-1==$.inArray(t[e],n)?null:void 0===a||void 0===r?t[o]:t[o][a][r]})}function k(t,e,n,o,a,r){void 0===r&&(r="Scores");var i={};return d3.nest().key(function(t){return t[n]}).entries(t).forEach(function(t){var n,s,d=(n=t.values,s=o,$.map(n,function(t,e){return t[s]})),l=N(e,o,d,r,a,0);i[t.key]=l}),i}function M(t,e){var n=0,o=[];return e?$.inArray(e,Object.keys(t))>-1&&(o=t[e].filter(Number)):t.length>0&&(o=t.filter(Number)),o.length>0&&(n=o.reduce(function(t,e){return t+e})/o.length),n}function B(t,e){var n;return(e=e.filter(Number)).sort(function(t,e){return t-e}),n=t*e.length,Math.floor(n)==n?(e[n-1]+e[n])/2:e[Math.floor(n)-1]}O.onAdd=function(t){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},O.update=function(t,e,n,o,a){var r=$("#subjectLabel").text();if(t)var i=o.obshtini[t.properties.obshtina],s=M(k(e,n,"Obshtina","ID",a.subjects[r]),i).toFixed(2);this._div.innerHTML=void 0!=i&s>0?"<h4>"+i+"</h4><br><b> Ср. успех ("+r+"): "+s+"</b>":"Посочете община"},O.addTo(y),$("#locationMail").click(function(){if(!$.isEmptyObject(u)){var t="mailto:opendata@government.bg?subject="+escape("SchoolMapLocationChanges"+(new Date).toJSON().slice(0,10))+"&body="+encodeURIComponent("Здравейте,\r\n\r\nсмятам че трябва да бъдат направени следните промени по местоположението на показаните училища.\r\n Моля, вижте приложения по-долу документ.\r\n\r\nПоздрави,\r\n\r\n")+escape(JSON.stringify(u,void 0,2));window.location.href=t}return!1})}();</script>'
                ],
                'active'     => 1,
                'type'       => Page::TYPE_PAGE,
            ],
            [
                'title'      => ['bg' => 'Престъпност', 'en' => 'Crime'],
                'section_id' => '',
                'body'       => [
                    'bg' => '<div class="container crime"> <div class="row-fluid"> <h3> Динамика на престъпността във времето </h3> <button type="button" class="btn btn-primary pull-right" data-toggle="modal" data-target="#infoModal" > <span class="glyphicon glyphicon-align-right" aria-hidden="true" ></span> </button> <div id="infoModal" class="modal fade" role="dialog"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal">&times;</button> <h4 class="modal-title">Анализ</h4> </div><div class="modal-body"> <ul class="list-group"> <li class="list-group-item"> <h4>Анализ на престъпността и разкриваемостта</h4> <p> Средната престъпност в страната спада през периода 2001-2008, но в рамките на следващите две години ситуацията се влошава до нивото от 2000 година. В последните 4 години престъпността намалява, като достига своя минимум през 2015<br>В същото време, разкриваемостта спада през последните 11 години от 61% през 2004 до 38% през 2014.<br>През 2014 София-град и Бургас са областите с най-висока престъпност, докато Смолян и Кърджали са с най-ниски нива за страната. В Бургас е втората най-ниска разкриваемост за страната.<br></p></li></ul> </div><div class="modal-footer"> <button type="button" class="btn btn-default" data-dismiss="modal">Затвори</button> </div></div></div></div><br><br><p> Настоящата страница предоставя средство за анализ на данните за динамиката на престъпността и разкриваемостта за последните 15 години, достъпни на <a href="https://www.mvr.bg/Planirane_otchetnost/Statistika/Police_statistika.htm">сайта на Министерсто на Вътрешните работи</a><br>От навигационното меню може да изберете вид на престълението, което да анализирате, като има са достъпни данни за всички 80 вида, отчитани от МВР в периода. За бърз преглед на данните е включена анимирано меню<br>Под картата са показани подробно и данните за нивото на престъпна дейност във всяка област и съответно разкиваемост. Областите могат да бъдат ранкиране на лесен сравнителен анализ.<br>Избирайки област с кликане на картата ще се обновят и графиките за динамиката на престъпността в периода в съответната община.<br>За преглед на подробен анализ на данните отворете бутона в дясно.<br>Суровите данни използвани в тази визуализация могат да бъдат свалени от <a href="https://github.com/governmentbg/data-viz/tree/gh-pages/assets/data/crime">тук</a>.<br></p></div><div class="vdivider"></div><div class="vdivider"></div><div class="navbar navbar-default" role="navigation"> <div class="navbar-header"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="#">Престъпления :</a> </div><div class="navbar-collapse collapse"> <ul class="nav navbar-nav"> <li id="navSelector"><a href="#">Общo<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Престъпления против личността<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Убийство<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Умишлено убийство<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Убийство по поръчка</a></li></ul> </li><li><a href="#">Умишлено убийство (опит)</a></li><li><a href="#">Убийство на новородено</a></li><li><a href="#">Подпомагане, склоняване към самоубийство</a></li></ul> </li><li><a href="#">Разврат<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Блудство</a></li><li><a href="#">Изнасилване</a></li><li><a href="#">Изнасилване (опит)</a></li><li><a href="#">Сводничество и отвличане за разврат</a></li><li><a href="#">Насилствен хомосексуализъм</a></li></ul> </li><li><a href="#">Телесна повреда<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Умишлена тежка телесна повреда</a></li></ul> </li><li><a href="#">Отвличане и противозаконно лишаване от свобода</a></li><li><a href="#">Задържане на заложник</a></li><li><a href="#">Трафик на хора</a></li><li><a href="#">Други против личността</a></li></ul> </li><li><a href="#">Престъпления против собствеността<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Грабеж<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Въоръжен грабеж<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Въоръжен грабеж чрез огнестрелно оръжие</a></li></ul> </li><li><a href="#">Магистрален грабеж<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Магистрален въоръжен грабеж</a></li></ul> </li></ul> </li><li><a href="#">Кражба<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Джебчийска кражба</a></li><li><a href="#">Взломна кражба</a></li><li><a href="#">Домова кражба</a></li><li><a href="#">Кражба от офиси</a></li><li><a href="#">Кражба от магазини</a></li><li><a href="#">Кражба на части и вещи от МПС</a></li><li><a href="#">Кражба на оръжие и боеприпаси</a></li><li><a href="#">Кражба на селскостопанска продукция, домашни животни и птици</a></li></ul> </li><li><a href="#">Измама</a></li><li><a href="#">Изнудване</a></li><li><a href="#">Други против собствеността</a></li></ul> </li><li><a href="#">Общоопасни престъпления<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Палеж<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Повреждане чрез взрив</a></li></ul> </li><li><a href="#">Незаконно производство, притежаване и използване на оръжие</a></li><li><a href="#">Посегателства спрямо МПС<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Противозаконно отнемане на МПС</a></li><li><a href="#">Съдействие при връщане на МПС с цел имотна облага</a></li><li><a href="#">Кражба на МПС</a></li><li><a href="#">Грабеж на МПС</a></li><li><a href="#">Грабеж на МПС от престъпна група</a></li></ul> </li><li><a href="#">Престъпления, свързани с наркотици<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Контрабанда</a></li><li><a href="#">Производство, притежаване, разпространение, пренасяне</a></li><li><a href="#">Склоняване към употреба</a></li><li><a href="#">Отглеждане на растения</a></li><li><a href="#">Превод на суми, придобити чрез трафик на наркотици</a></li><li><a href="#">Финансови операции и сделки със суми</a></li><li><a href="#">Възпрепятстване контрол</a></li><li><a href="#">Неправомерен контрол</a></li></ul> </li><li><a href="#">Престъпления по транспорта<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Транспортни убийства по непредпазливост</a></li><li><a href="#">Транспортни телесни повреди по непредпазливост</a></li></ul> </li><li><a href="#">Други общоопасни</a></li></ul> </li><li><a href="#">Други криминални престъпления<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Престъпления против правата на гражданите</a></li><li><a href="#">Престъпления против брака, семейството и младежта<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Незаконно осиновяване</a></li><li><a href="#">Неплащане на издръжка</a></li></ul> </li><li><a href="#">Престъпления против дейността на държавни и обществени организации<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Използване на полицейски знаци</a></li><li><a href="#">Незаконно преминаване през граница</a></li><li><a href="#">Превеждане през граница</a></li></ul> </li><li><a href="#">Компютърни престъпления</a></li><li><a href="#">Престъпления против реда и общественото спокойствие<span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="#">Образуване и участие в престъпна група</a></li><li><a href="#">Хулиганство</a></li></ul> </li><li><a href="#">Други</a></li></ul> </li><li><a href="#">Смъртни случаи без следи от насилие</a></li></ul> </li></ul> </div></div><div id="animation-container" class="row-fluid"> <div id="play" class="to-top"></div><div id="slider-container" class="to-top"> <div id="slider-div"></div></div></div><div class="vdivider"> </div><div class="vdivider"> </div><h4 id="maptitle" class="title">Карта на престъпността в страната</h4> <div id="maplegend"> <div id="mapregionlegend" class="sidebyside to-top"> <div>Нивото на престъпност (на хил души)</div></div><div id="mapbublelegend" class="sidebyside"> <div class="div-right">Процент разкрити престъпления</div></div></div><div id="path-tooltip" class="path-hidden"> <p><strong><span id="path-oblast">Име на област</span></strong></p><p><span id="path-value">100</span></p><p><span id="path-year">2001</span></p></div><div id="map-container"></div><div class="vdivider"> </div><div class="vdivider"> </div><div class="vdivider"> </div><div class="row"> <h4 id="firstRowTitle" class="title"></h4> <div class="col-2 col-lg-6 col-md-6 col-sm-6 panel"> <h4 id="barChartOccuredTitle">Престъпност по области (на хил.души)</h4> <label><input id="barChartOccuredSort" type="checkbox">Ранкирай</label> <div id="barChartOccured"></div></div><div class="col-2 col-lg-6 col-md-6 col-sm-6 panel"> <h4 id="barChartRevealedTitle">Разкриваемост по области</h4> <label><input id="barChartRevealedSort" type="checkbox">Ранкирай</label> <div id="barChartRevealed"></div></div></div><div class="row"> <h4 id="secondRowTitle" class="title"></h4> <div class="col-2 col-lg-6 col-md-6 col-sm-6 panel"> <h4 id="dualLineChartTotalsTitle">Динамика на престъпността и разкриваемостта</h4> <div id="dualLineChartTotals"></div></div><div class="col-2 col-lg-6 col-md-6 col-sm-6 panel"> <h4 id="multiLineChartPrcsTitle">Ръст на престъпността и разкриваемостта</h4> <div id="multiLineChartPrcs"></div></div></div><div class="vdivider"> </div></div><script>$(function(){function t(t){var e=0,a={};for(_ in t)_==Object.keys(t)[0]?e=t[_]:(a[_]=100*(t[_]/e-1),e=t[_]);return a}function e(t,e,a,r,n){return o={},$.map(t,function(t){return $.inArray(t[e],a)>-1?(_={},_[t[r]]=+t[n],$.extend(o,_),o):null}),o}function a(t,e,a,r,n,i){return $.map(t,function(t){return $.inArray(t[e],a)>-1&&$.inArray(t[r],n)>-1?t[i]:null})}function r(t,e){$("#maptitle").text("Карта на престъпността в страната за "+t+" година : "+e)}queue().defer(d3.json,"'. url('/assets/topojson/bg-oblasti-simple.json') .'").defer(d3.csv,"'. url('/assets/data/crime/mvr-aggr-13-perth.csv') .'").defer(d3.csv,"'. url('/assets/data/crime/mvr-aggr-13-prc.csv') .'").defer(d3.json,"'. url('/assets/data/crime/recoded-en-bg-crime.json') .'").await(function(o,l,s,_,L){if(o)throw o;(function(){sliderScale=d3.scale.linear().domain([h,p]);var t=w?w.value():h;w=d3.slider().axis(d3.svg.axis().ticks(p-h+1).tickFormat(function(t){return T(t)})).min(h).max(p).step(1).on("slide",function(t,e){C&&clearInterval(interval),y=!0,tt(u=e)}).on("slideend",function(t){C&&Z()}).value(t),d3.select("#slider-div").remove();var e=d3.select("#animation-container").node().getBoundingClientRect().width,a=d3.select("#play").node().getBoundingClientRect().width;d3.select("#slider-container").append("div").attr("id","slider-div").style("width",e-a-50+"px").call(w),i&&d3.selectAll(".d3-slider-axis text").attr("transform",function(t){return"translate("+-this.getBBox().height+","+1.5*this.getBBox().height+")rotate(-90)"})})(),d3.select("#play").attr("title","Play animation").on("click",function(){C?(C=!1,d3.select(this).classed("pause",!1).attr("title","Play animation"),clearInterval(interval)):(u==p&&(u=h-1),C=!0,d3.select(this).classed("pause",!0).attr("title","Pause animation"),Z())});var P=d3.map(),I=d3.map(),D=d3.map(),E=d3.map();function q(t){f.forEach(function(t){P.set(t,e(s,"Year",[t.toString()],"Oblast",b)),D.set(t,e(_,"Year",[t.toString()],"Oblast",b))}),v.forEach(function(t){I.set(t,e(s,"Oblast",[t],"Year",b)),E.set(t,e(_,"Oblast",[t],"Year",b))})}q(b),n.on("load.obars",function(t,e){var a=$("#barChartOccured").width(),r=sortedBarChart().data(P.get(u)).width(a).height(400).formatType(",.0f"),i=sortedBarChart().data(D.get(u)).width(a).height(400).formatType("%");n.on("yearChange.obars",function(t,e){r.data(t),i.data(e)}),n.on("sortBarChartO.obars",function(t){r.sortData(t)}),n.on("sortBarChartR.obars",function(t){i.sortData(t)}),d3.select("#barChartOccured").call(r),d3.select("#barChartRevealed").call(i),highlightBar=function(t,e){t.each(function(t){d3.select(this).style("fill",function(t){return e==t[0]?"#f0f059":""})})}}),n.on("load.lines",function(e,a){var r=$("#dualLineChartTotals").width(),i=dualLineChart().data([I.get(m),E.get(m)]).width(r),o=multiLineChart().data({"ръст престъпност":t(I.get(m)),"ръст разкрития":t(E.get(m))}).width(r);d3.select("#dualLineChartTotals").call(i),d3.select("#multiLineChartPrcs").call(o),n.on("oblastFocus.lines",function(e,a){i.data([e,a]),o.data({"ръст престъпност":t(e),"ръст разкрития":t(a)})})}),n.load(),n.yearChange(P.get(u),D.get(u)),n.oblastFocus(I.get(m),E.get(m),m),$(".navbar-nav a").on("click",function(t){!function(t){b=t,r(u,L["crimes-inv"][b]),W(b),X(u,b),q(b),n.yearChange(P.get(u),D.get(u)),n.oblastFocus(I.get(m),E.get(m),m),d3.select("#barChartOccuredSort").property("checked")&&n.sortBarChartO(!0);d3.select("#barChartRevealedSort").property("checked")&&n.sortBarChartR(!0)}(L.crimes[this.text])}),d3.select("#barChartOccuredSort").on("change",function(){n.sortBarChartO(this.checked)}),d3.select("#barChartRevealedSort").on("change",function(){n.sortBarChartR(this.checked)});var M=topojson.feature(l,l.objects.regions),z=d3.select("#map-container").node().getBoundingClientRect(),G=z.width,H=z.height;x.scale(1).translate([0,0]);var J=O.bounds(M),K=.9/Math.max((J[1][0]-J[0][0])/G,(J[1][1]-J[0][1])/H),N=[(G-K*(J[1][0]+J[0][0]))/2,(H-K*(J[1][1]+J[0][1]))/2];x.scale(K).translate(N),B=R.append("g").attr("class","boundary"),region=B.selectAll(".region").data(M.features);var Q={},U=(d3.select("#path-tooltip"),d3.select("#mapregionlegend").append("ul").attr("class","list-inline"));function V(t){var e,a=L.oblasti[t.properties.oblast];a&&m!==a&&(e=m=a,$("#secondRowTitle").text("Динамика на престъпността и разкриваемостта в "+e),n.oblastFocus(I.get(m),E.get(m),m),highlightBar(d3.select("#barChartOccured").selectAll("rect"),m),highlightBar(d3.select("#barChartRevealed").selectAll("rect"),m))}function W(t){var e,a,r,n=(e=s,a=t,r=!0,$.map(e,function(t,e){return r?+t[a]:t[a]}));k.domain([d3.min(n),d3.max(n)]).range([0,100]);var i={};for(g=0;g<c.length;g++)i[c[g]]=k.invert(d[g]);var o=U.selectAll("li.key").data(d);o.enter().append("li").attr("class","key").style("border-top-color",function(t){return S(t)}),o.text(function(t){var e=i[S(t)];return Y(e)})}function X(t,e){region.transition().duration(1e3).style("fill",function(r){var n=L.oblasti[r.properties.oblast],i=+a(s,"Oblast",[n],"Year",[t.toString()],e)[0];return Q[r.properties.oblast]=+a(_,"Oblast",[n],"Year",[t.toString()],e)[0],void 0!=i?S(k(i)):"#cccccc"}),d3.selectAll(".region").each(function(t){var e=t.properties.oblast,a="#cir"+e.replace(" ",""),r="#ctxt"+e.replace(" ","");d3.select(a).transition().duration(1e3).attr("r",j(Q[e])).attr("fill",A(Q[e])),d3.select(r).text(F(Q[e]/100))})}function Z(){interval=setInterval(function(){if(y&&(y=!1),u++,d3.select("#slider-div .d3-slider-handle").style("left",100*u/p+"%"),w.value(u),tt(u),u==p)return C=!1,d3.select("#play").classed("pause",!1).attr("title","Play animation"),void clearInterval(interval)},1e3)}function tt(t){var e;r(t,L["crimes-inv"][b]),X(t,b),e=t,$("#firstRowTitle").text("Престъпност и разкриваемост по области за "+e+" година"),n.yearChange(P.get(t),D.get(t)),d3.select("#barChartOccuredSort").property("checked")&&n.sortBarChartO(!0),d3.select("#barChartRevealedSort").property("checked")&&n.sortBarChartR(!0)}region.enter().append("path").attr("class","region").attr("d",O).attr("id",function(t,e){return t.properties.oblast.replace(" ","")}).on("click",function(t){V(t)}),W(b),X(h,b),d3.selectAll(".region").each(function(t){var e=B.append("g").attr("transform",function(e){var a=t.properties.oblast,r=0,n=0,i="#"+a.replace(" ",""),o=d3.select(i),l=O.centroid(o.datum());return"Sofia"===a&&(r=.15*l[0],n=.05*-l[1]),"translate("+(l[0]+r)+","+(l[1]+n)+")"});e.append("circle").attr("r",j(Q[t.properties.oblast])).attr("id","cir"+t.properties.oblast.replace(" ","")).attr("fill",A(Q[t.properties.oblast])),e.append("text").attr("id","ctxt"+t.properties.oblast.replace(" ","")).attr("dx",function(t){return-15}).attr("dy",function(t){return 5}).text(F(Q[t.properties.oblast]/100))})});var n=d3.dispatch("load","yearChange","sortBarChartO","sortBarChartR","oblastFocus"),i=!1,l=.5*$(window).height(),s=$(window).width()>=980?900:.9*$(window).width();($(window).width()<=$(window).height()||$(window).width()<600)&&(i=!0,l=$(window).height()<400?.8*$(window).height():.6*$(window).height()),$(window).height()<610&&$(window).width()>1e3&&(l=.8*$(window).height());for(var c=["#ff1004","#ff5262","#d1b60d","#14bb11"],d=[100,50,30,0],h=2e3,u=2e3,p=2014,f=[],g=h;g<=p;g++)f.push(g);var v=["Благоевград","Бургас","Варна","Велико Търново","Видин","Враца","Габрово","Добрич","Кърджали","Кюстендил","Ловеч","Монтана","Пазарджик","Перник","Плевен","Пловдив","Разград","Русе","Силистра","Сливен","Смолян","София  град","София","Стара Загора","Търговище","Хасково","Шумен","Ямбол","Общo"],b="0",m="Общo";$("#firstRowTitle").text("Престъпност и разкриваемост по области за "+u+" година"),$("#secondRowTitle").text("Динамика на престъпността и разкриваемостта в "+m);var w,C=!1,y=!1,x=d3.geo.mercator(),B=void 0,O=d3.geo.path().projection(x),R=d3.select("#map-container").append("svg").attr("width","100%").attr("height",l),k=d3.scale.linear(),S=d3.scale.linear().domain(d).range(c),A=d3.scale.linear().domain([0,60,100]).range(["#fe1e13","#dfbe10","#91bb11"]),j=d3.scale.linear().domain([0,100]).range([.06*l,.02*l]),T=d3.format("04d"),F=d3.format("0.00%"),Y=d3.format("0f"),L=d3.select("#mapbublelegend").append("svg").attr("class","legend-bubble").attr("width",.3*s).attr("height",.15*l).selectAll("svg").data([20,40,60,80]).enter().append("g").attr("transform",function(t,e){return"translate("+(.15*l+2*e*j(t/1.8))+",36)"});L.append("circle").attr("r",function(t){return j(t)}).attr("fill",function(t){return A(t)}),L.append("text").attr("dx",-15).attr("dy",5).text(function(t){return F(t/100)})}());</script>'
                ],
                'active'     => 1,
                'type'       => Page::TYPE_PAGE,
            ],
            [
                'title'      => ['bg' => 'Здравна система', 'en' => 'Health system'],
                'section_id' => '',
                'body'       => [
                    'bg' => '<div class="container"> <div class="row-fluid"> <h3> Демонстрация на визуализации - Интерактивно табло </h3> <p> Визуализацията на отворени данни в здравеопазването под формата на интерактивни табла свързва информация от различни източници и има голям аналитичен потенциал.<br>Показаното табло дава възможност за анализ на представянето на здравната система по области в страната. Данните, захранващи таблото, включват информация от Националния статистически институт за осигуреността на населението със здравен персонал и данни за смъртността. Те са свързани с данни за плащанията, извършени по Национална здравноосигурителна каса към РЗОК по области. Дейтални записки за използвания набор от данни могат да бъдат намерени тук.<br>Първата графика дава обобщена картина за представянето на здравната система. <br>По хоризонтала е показана усреднената динамика на смъртността за избраните години (по подразбиране 2006-2013). Колкото по-наляво се намира един кръг, толкова по-голям е спадът на смърността на хиляда души за периода.<br>По вертикала е показана усреднената динамика на осигуреността за избраните години. Колкото по-нагоре се намира един кръг, толкова по-голям е ръстът на осигуреността с лекари на хиляда души за периода.<br>Големината на всеки кръг демонстрира кумулативния обем на средствата, изплатени от НЗОК за избраните години. Оцветяването отразява обема на изплатените средства в сравнение със средното за страната.<br>Суровите данни използвани в тази визуализация могат да бъдат свалени от <a href="https://github.com/governmentbg/data-viz/tree/gh-pages/assets/data/hc-dashboard">тук</a><br></p></div><div class="row-fluid"> <div id="region-bubble-chart" class="bubble-graph span12"> <strong>Представяне в здравеопазването</strong><br><a class="reset" href="javascript:regionBubbleChart.filterAll();dc.redrawAll();" style="display: none;">Изчисти</a> <span class="reset" style="display: none;">Приложен филтър: <span class="filter"></span></span> </div></div><div class="row-fluid"> <div class="span4"> <div id="bigregion-pie-chart" class="dc-chart"> <strong>Изплатени средства по статистически региони</strong><br><a class="reset" href="javascript:bigregionPieChart.filterAll();dc.redrawAll();" style="display: none;">Изчисти</a> <span class="reset" style="display: none;">Приложен филтър: <span class="filter"></span></span><br></div></div><div class="span4"> <div id="yearly-row-chart" class="dc-chart"> <strong>Изплатени средства от НЗОК по години</strong><br>Приложен филтър: <span class="filter"></span></span><br></div></div><div class="span4"> <div id="better-pie-chart" class="dc-chart"> <strong>Динамика на нивото на смъртността</strong><br><a class="reset" href="javascript:betterOrWorsePieChart.filterAll();dc.redrawAll();" style="display: none;">Изчисти</a> <span class="reset" style="display: none;">Приложен филтър: <span class="filter"></span></span><br></div></div></div><div class="row-fluid"> <div id="region-bar-chart" class="dc-chart"> <strong>Изплатени средства от НЗОК по региони</strong> <a class="reset" href="javascript:regionBarChart.filterAll();dc.redrawAll();" style="display: none;">Изчисти</a> <span class="reset" style="display: none;">Приложен филтър: <span class="filter"></span></span><br></div></div><div class="row-fluid"> <div id="data-count" class="dc-data-count dc-chart"> <span class="filter-count"></span> записа издбрани от <span class="total-count"></span> записа </div></div><div class="row-fluid"> <div id="data-table" class="table table-hover"> </div></div><div id="attributions" class="row-fluid"></div></div><script>var widthAsString=d3.select(".container").style("width"),w=parseInt(widthAsString,10),h=w/2.25,w_sh=w/5,h_sh=w_sh,regionBubbleChart=dc.bubbleChart("#region-bubble-chart"),betterOrWorsePieChart=dc.pieChart("#better-pie-chart"),yearlyRowChart=dc.rowChart("#yearly-row-chart"),bigregionPieChart=dc.pieChart("#bigregion-pie-chart"),regionBarChart=dc.barChart("#region-bar-chart"),htx=null,all=null,regionDimension=null,regionDimension2=null,regionPerformanceGroup=null,betterOrWorse=null,betterOrWorseGroup=null,dateDimension=null,dateFundingGroup=null,medicsGroup=null,bigregionDim=null,bigregionCoverageGroup=null,dateFormat=d3.time.format("%Y"),numberFormatShort=d3.format(".1f"),numberFormatStd=d3.format(".2f"),numberFormatLong=d3.format(".4f"),pieColors=["#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a"];function loadData(){d3.csv("'. url('/assets/data/hc-dashboard/dashboard.csv') .'",function(e,r){r.forEach(function(e){e.year=dateFormat.parse(e.year);var r=["year","region","bigregion"];for(var n in e)e.hasOwnProperty(n)&&-1===r.indexOf(n)&&(e[n]=+e[n])}),loadCrossfilter(r)})}function loadCrossfilter(e){htx=crossfilter(e),all=htx.groupAll(),regionDimension=htx.dimension(function(e){return e.region}),regionPerformanceGroup=regionDimension.group().reduce(function(e,r){return++e.count,e.sumDiffRelMds+=r.diffRelMds,e.avgDiffRelMds=0===e.count?0:e.sumDiffRelMds/e.count,e.sumDiffRelDeaths+=r.diffRelDeaths,e.avgDiffRelDeaths=0===e.count?0:e.sumDiffRelDeaths/e.count,e.sumDiffNhifFunding+=r.diffNhifFunding,e.avgDiffNhifFunding=0===e.count?0:e.sumDiffNhifFunding/e.count,e},function(e,r){return--e.count,e.sumDiffRelMds-=r.diffRelMds,e.avgDiffRelMds=0===e.count?0:e.sumDiffRelMds/e.count,e.sumDiffRelDeaths-=r.diffRelDeaths,e.avgDiffRelDeaths=0===e.count?0:e.sumDiffRelDeaths/e.count,e.sumDiffNhifFunding-=r.diffNhifFunding,e.avgDiffNhifFunding=0===e.count?0:e.sumDiffNhifFunding/e.count,e},function(){return{sumDiffRelMds:0,avgDiffRelMds:0,sumDiffRelDeaths:0,avgDiffRelDeaths:0,sumDiffNhifFunding:0,avgDiffNhifFunding:0,count:0}}),regionDimension2=htx.dimension(function(e){return e.region}),regionFundingGroup=regionDimension2.group().reduceSum(function(e){return e.nhifFunding/1e5}).orderNatural(),betterOrWorse=htx.dimension(function(e){return e.diffRelDeaths>0?"Ръст":"Спад"}),betterOrWorseGroup=betterOrWorse.group(),dateDimension=htx.dimension(function(e){return d3.time.year(e.year).getFullYear()}),dateFundingGroup=dateDimension.group().reduceSum(function(e){return e.nhifFunding/1e5}),bigregionDim=htx.dimension(function(e){return e.bigregion}),bigregionFundingGroup=bigregionDim.group().reduceSum(function(e){return e.nhifFunding/1e5}),doCharts()}function doCharts(){regionBubbleChart.width(w).height(h).transitionDuration(1500).margins({top:10,right:50,bottom:30,left:40}).dimension(regionDimension).group(regionPerformanceGroup).colors(["#a6bddb","#1c9099"]).colorDomain([-100,250]).colorAccessor(function(e){return e.value.avgDiffNhifFunding}).keyAccessor(function(e){return e.value.avgDiffRelDeaths}).valueAccessor(function(e){return e.value.avgDiffRelMds}).radiusValueAccessor(function(e){return Math.abs(e.value.avgDiffNhifFunding)}).maxBubbleRelativeSize(.2).x(d3.scale.linear().domain([-500,500])).y(d3.scale.linear().domain([-100,100])).r(d3.scale.linear().domain([0,1e3])).elasticY(!0).elasticX(!0).yAxisPadding(5).xAxisPadding(5).renderHorizontalGridLines(!0).renderVerticalGridLines(!0).xAxisLabel("Усреднена динамика на смъртността").yAxisLabel("Усреднен прираст на осигуренността").renderLabel(!0).label(function(e){return e.key}).renderTitle(!0).title(function(e){return[e.key,"Усреднена динамика на смъртността: "+numberFormatShort(e.value.avgDiffRelDeaths),"Усреднен прираст на осигуренността: "+numberFormatShort(e.value.avgDiffRelMds),"Усреднен прираст на финансирането: "+numberFormatShort(e.value.avgDiffNhifFunding)+"стотици хил. лв."].join("\n")}),bigregionPieChart.width(w_sh).height(h_sh).radius((w_sh-20)/2).dimension(bigregionDim).group(bigregionFundingGroup).ordinalColors(["#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59"]),yearlyRowChart.width(1.5*w_sh).height(h_sh).group(dateFundingGroup).dimension(dateDimension).ordinalColors(["#b3cce5","#9ebddc","#88add3","#739eca","#5e8fc0","#487fb7","#3370ae","#1d60a5","#08519c"]).label(function(e){return e.key}).title(function(e){return e.value}).elasticX(!0).xAxis().ticks(4),betterOrWorsePieChart.width(w_sh).height(h_sh).radius((w_sh-20)/2).dimension(betterOrWorse).group(betterOrWorseGroup).label(function(e){if(betterOrWorsePieChart.hasFilter()&&!betterOrWorsePieChart.hasFilter(e.key))return e.key+"(0%)";var r=e.key;return all.value()&&(r+="("+Math.floor(e.value/all.value()*100)+"%)"),r}),regionBarChart.width(w).height(.8*h).margins({top:10,right:30,bottom:100,left:50}).dimension(regionDimension2).group(regionFundingGroup).elasticY(!0).gap(1).x(d3.scale.ordinal()).xUnits(dc.units.ordinal).ordering(function(e){return-e.value}).renderlet(function(e){e.selectAll("g.x text").attr("dx","-40").attr("dy","-7").attr("transform","rotate(-90)")}),dc.dataCount(".dc-data-count").dimension(htx).group(all).html({some:"<strong>%filter-count</strong> записа избрани от <strong>%total-count</strong> записа | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'\'>изчисти всички</a>",all:"Всички записи са селектирани. Натисни върху графика, за да филтрираш."}),dc.dataTable("#data-table").dimension(dateDimension).group(function(e){return e.year.getFullYear()}).columns([{label:"Година",format:function(e){return e.year.getFullYear()}},{label:"Регион",format:function(e){return e.region}},{label:"Динамика лекари на хил. души спрямо предходната год",format:function(e){return numberFormatStd(e.diffRelMds)}},{label:"Динамика смъртност на хил. души спрямо предходната год",format:function(e){return numberFormatStd(e.diffRelDeaths)}},{label:"Динамика финансиране в стотици хиляди лева спрямо предходната год",format:function(e){return e.diffNhifFunding}}]).sortBy(function(e){return e.diffNhifFunding}).order(d3.descending).renderlet(function(e){e.selectAll(".dc-table-group").classed("info",!0)}),dc.renderAll()}loadData();</script>'
                ],
                'active'     => 1,
                'type'       => Page::TYPE_PAGE,
            ],
        ];
    }


    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        if (!config('app.IS_TOOL')) {
            $userId = User::where('username', 'system')->value('id');

            try {
                foreach ($this->pages as $page) {
                    $newPage = new Page;

                    $newPage->title = $page['title'];
                    $newPage->section_id = null;
                    $newPage->body = $page['body'];
                    $newPage->active = $page['active'];
                    $newPage->type = $page['type'];
                    $newPage->created_by = $userId;

                    $newPage->save();
                }

                DB::commit();
            } catch (QueryException $e) {
                DB::rollback();
                Log::error($e->getMessage());
            }
        }
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        if (!config('app.IS_TOOL')) {
            $userId = User::where('username', 'system')->value('id');

            foreach ($this->pages as $page) {
                $pageTrans = DB::table('translations')
                    ->where('label', $page['title']['bg'])
                    ->where('locale', 'bg')
                    ->where('created_by', $userId)
                    ->get()
                    ->last();

                $pageGroupId = !is_null($pageTrans) ? $pageTrans->group_id : null;

                DB::table('translations')
                    ->where('group_id', $pageGroupId)
                    ->delete();

                Page::where('title', $pageGroupId)
                    ->where('created_by', $userId)
                    ->delete();
            }
        }
    }
}
